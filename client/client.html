<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

  </script>
</head>
<body>
  <section id="header">
    <h3>Chatter</h3>
  </section>
    <div id="identity">
      Logged in as [PLACEHOLDER]
    </div>
    <form id="commentForm" action="/comment" method="post">
      <label for="comment"> Speak your mind! </label>
      <input id="commentField"/>
      <input type="submit" value="Post" />
    </form>
  <section id="content"></section>
</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>

  <script type="text/babel"></script><script>

    const parseJSON = (xhr, content) => {
      //console.log(xhr.response);
      if(!xhr.response) return;
      //parse response (obj will be empty in a 204 updated)
      const obj = JSON.parse(xhr.response);
      const forum = document.querySelector("#content");

      if(obj.comments) {
      
        content.innerHTML = "";

        for(var i=obj.comments.all.length-1; i>=0; i--){
          var comment = document.createElement("div");
          var username = document.createElement("h3");
          var message = document.createElement("p");

          comment.className = "comment";

          username.innerHTML = obj.comments.all[i].user;
          message.innerHTML = obj.comments.all[i].message;

          comment.appendChild(username);
          comment.appendChild(message);
          forum.appendChild(comment);

        }
      }
    };

    //function to handle our response
    const handleResponse = (xhr) => {
      const content = document.querySelector('#content');
      
      //check the status code
      switch(xhr.status) {
        case 200: //success
          //content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          //content.innerHTML = '<b>Create</b>';
          break;
        case 204: //updated (no response back from server)
          //content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 304:
          //content.innerHTML = "<b>Success (Not Modified)</b>"
          return;
        case 400: //bad request
          //content.innerHTML = `<b>Bad Request</b>`;
          break;
        default: //any other status code
          //content.innerHTML = `<b>Resource Not Found</b>.`;
          break;
      }

      //parse response 
      parseJSON(xhr, content);
    };

    //function to send our post request
    const sendPost = (e, form) => {
      
      //grab the form's name and age fields so we can check user input
      const messageField = form.querySelector('#commentField');
      
      //create a new Ajax request (remember this is asynchronous)
      const xhr = new XMLHttpRequest();
      //set the method (POST) and url (action field from form)
      xhr.open('post', 'addComment');
      
      //set our request type to x-www-form-urlencoded
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      //set our requested response type in hopes of a JSON response
      xhr.setRequestHeader ('Accept', 'application/json');
      
      //set our function to handle the response
      xhr.onload = () => handleResponse(xhr);

      const currentUser = "test";
      
      //build our x-www-form-urlencoded format.
      const formData = `user=${currentUser}&message=${messageField.value}`;
      
      //send our request with the data
      xhr.send(formData);
    
      //prevent the browser's default action (to send the form on its own)
      e.preventDefault();

      //Clear out the old message
      messageField.value = "";

      //return false to prevent the browser from trying to change page
      return false;
    };

    const init = () => {
      //grab form
      const commentForm = document.querySelector('#commentForm');
      
      //create handler
      const addComment = (e) => sendPost(e, commentForm);
      
      //attach submit event (for clicking submit or hitting enter)
      commentForm.addEventListener('submit', addComment);

      //attach submit event for getting users
      commentForm.addEventListener("submit", function(e){

        getStuff(e);
      });

      getStuff();
    };

    const getStuff = (e) => {

        const method = 'get';
        const url = 'getComments';

        console.log(method+", "+url);

        var xhr = new XMLHttpRequest();
        xhr.open(method, url);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.onload = () => handleResponse(xhr);
        xhr.send();

        if(e) e.preventDefault();
        return false;
      };

    window.onload = init;

  </script>

</html>